---
title: "Exploring Inefficiencies and Bail Reform in Cook County Criminal Justice System"
author: "Damini Sharma"
output: html_document
  # html_document:
  #   code_folding: hide
  #   toc: true
  #   toc_depth: 3
  #   toc_float:
  #     collapsed: false

---

```{r warning=FALSE , message=FALSE, include=FALSE}
# load necessary packages 
libs <- c("tidyverse", "stringr", "readr", "dplyr", "ggplot2", "readstata13","foreign",
          "magrittr","lubridate","here","ggrepel","treemapify","packcircles", "ggalluvial","ggrepel",
          "extrafont","ggfittext","cowplot","googleway","ggspatial","sf","rnaturalearth",
          "rnaturalearthdata","rgeos","ggridges")

lapply(libs, library, character.only=TRUE)

# loadfonts()
# source("theme.R")
```

```{r warning=FALSE , message=FALSE, echo=FALSE}
my_theme <- theme(plot.background = element_rect(fill="#FFFFFF", color = "white"),
                  plot.title = element_text(family="Tahoma", face="bold", size=14, hjust=0),
                  plot.subtitle = element_text(family="Tahoma",size=10),
                  plot.margin=unit(c(1,1,1,1),"cm"),
                  plot.caption = element_text(family="Tahoma", size=8),
              
                  panel.background = element_rect(fill = "#FFFFFF"),
                  panel.grid.major.y = element_line(color="#717175", size=0.25),
                  panel.grid.minor.y = element_line(color="#717175", size=0.25),
                  panel.grid.minor.x=element_blank(),
                  panel.grid.major.x=element_blank(),
                  
                  legend.background = element_rect(fill="#FFFFFF", color = "#FFFFFF"),
                  legend.key = element_blank(),
                  legend.title = element_text(family="Tahoma", size=10),
                  legend.text = element_text(family="Tahoma", size=8),
                  
                  axis.ticks.y = element_blank(),
                  axis.ticks.x = element_blank(),
                  axis.text = element_text(family="Tahoma", size=8),
                  axis.title = element_text(family="Tahoma", size=9),
                  axis.title.x = element_text(margin=margin(t=15)),
                  axis.title.y = element_text(margin=margin(r=15)),
                  
                  text = element_text(family = "Tahoma", size = 7))

```

[SAO data](https://datacatalog.cookcountyil.gov/browse?tags=state%27s%20attorney%20case-level&sortBy=most_accessed)  

[Chicago Data Collaborative](https://chicagodatacollaborative.org/)  

[GitHub Repository](https://github.com/DSharm/CookCountyCriminalJustice)

### Background
The Cook County State's Attorney's Office (SAO) is the second largest prosecutor's office in the United States. Tens of thousands of criminal cases are prosecuted every year by the Office, across 100 law enforcement jurisdictions and in service of over five million residents of Cook County. When she took office in December 2016, State's Attorney Kim Foxx announced a largely unprecedented commitment to improving the transparency of the SAO's work. Accordingly, in 2017 the SAO released a Baseline Data Report, along with de-identified data capturing snapshots of all cases that go through the SAO from arrest to sentencing. While some of the data goes as far back as the early 2000s, due to changes in the accuracy of storing and reporting the data, it is more reliable starting in 2011. 

#### Criticism of SAO
Cook County has been criticized of having excessive lags in the process from arrest to sentencing. Such long delays can prove incredibly disruptive in the life of a defendant, especially if they are held in jail. Using the data released by the SAO, I would like to see if the data does, indeed, show long lags between incident, arrest, felony review, arraignment, and sentencing. In particular, I’d be interested to see whether these lags have any variation when looked at across time, types of offenses, districts, or judges. Understanding these nuances could shed light on where the bottleneck is happening, if at all.

In addition to excessive lags, recent media attention has shed light on the arbitrary decision-making in bond court and how it penalizes the poor. Many people are held pretrial simply because they cannot pay the bail amount, rather than being held because they pose a flight risk. The data on this topic is unfortunately sparse, and the SAO data also does not capture any information on this step of the process. 

However, the subject received greater attention in Chicago when SA Kim Foxx announced in June 2017 that her office was pushing to reform this arbitrary system and recommending courts post no bail amount for defendants who don’t present a flight risk. Following that, the Governor signed into law a bill pushed by SA Foxx to this effect. External organizations, such as Chicago Appleseed, have written about this subject and compiled their own datasets, using bond court observations and data requested from the Bond Court through FOIA requests. Some of this data has been made public. While it is not as robust or rich as the SAO data, I explore the data requested from Bond Court to see if there are signs of change or improvement since the bill was passed.

### Case Length: Arrest To Sentencing 
I start by looking at the Sentences data from the SAO to see how the average length of case (from arrest to sentencing) has changed from 2011 to 2018. In addition to the average case length, I plot total number of defendants per month that are sentenced and the total number of days spent on cases each month in the same time period. All three are plotted as percentage of the February 2011 value. Note, throughout the analysis I restrict the datasets to only include the top-level charge of a case-participant (since case-participants can have numerous charges. We revisit this point later). 


```{r warning=FALSE, message = FALSE, fig.align='center',echo=FALSE}
# Read in the data
intake <- read.csv(here('data_source','SAO Data','Intake.csv'),stringsAsFactors = FALSE) 
initiation <- read.csv(here("data_source","SAO Data","Initiation.csv"),stringsAsFactors = FALSE) 
sentence <- read.csv(here("data_source","SAO Data","Sentencing.csv"),stringsAsFactors = FALSE) 
disposition <- read.csv(here("data_source","SAO Data","Dispositions.csv"),stringsAsFactors = FALSE) 
```

```{r warning=FALSE, message = FALSE, fig.align='center',echo=FALSE}
# Clean data

# For graph 1, we look at sentences data only. 
# There is already a length of case in days variable but this is from arraignment to 
# sentencing, and I want to start at arrest so I define my own

# Since the sentencing data is not unique on case participant ID, I first collapse the data
# to get an average case length per participant ID. This is because many defendants will have
# multiple charges, and say each charge takes 8 days to go from arraignment to sentencing. Those
# are the same 8 days, so we don't want to double count them.

# Filtering only to primary charge throughout
sentence %<>%
  mutate(SENTENCE_DATE = as.Date(SENTENCE_DATE,'%m/%d/%Y' )) %>% 
  mutate(ARREST_DATE = as.Date(ARREST_DATE,'%m/%d/%Y' )) %>% 
  mutate(case_length_total = unclass(difftime(SENTENCE_DATE,ARREST_DATE,units = "days"))) %>%
  mutate(sentence_month = round_date(SENTENCE_DATE, "month"))  %>% 
  filter(PRIMARY_CHARGE == "true")

case_length <- sentence %>% 
  group_by(sentence_month, CASE_PARTICIPANT_ID) %>% 
  summarise(case_length_p = mean(case_length_total, na.rm = TRUE)) %>% 
  group_by(sentence_month) %>% 
  summarise(felonies_total = n_distinct(CASE_PARTICIPANT_ID), 
            case_length_total = sum(case_length_p, na.rm = TRUE),
            avg_case_length = mean(case_length_p, na.rm = TRUE)) %>% 
  filter(felonies_total > 0) %>% 
  filter(case_length_total > 0) %>% 
  filter(avg_case_length > 0 & avg_case_length < 2000) %>% 
  filter(sentence_month > "2011-01-01" & sentence_month < "2018-01-01") %>% 
  gather(type_measure,n,felonies_total:avg_case_length)

case_length_2011 <- case_length %>% filter(sentence_month == "2011-02-01") %>% select(-sentence_month)

# merge this value back onto long dataset
case_length_as_pct <- left_join(case_length, case_length_2011, by="type_measure") %>% 
  mutate(pct_change = (n.x / n.y))
```


```{r warning=FALSE, message = FALSE, fig.align='center',echo=FALSE}

plot1 <- 
  case_length_as_pct %>% 
  ggplot(aes(x=sentence_month, y=pct_change, color=type_measure)) + 
  #geom_line(size=0.4) +
  geom_point(size = 0.4) +
  geom_smooth(size=0.3) +
  scale_color_manual(values=c("#99112C","#0B729A","#0B9157")) +
  theme_classic() +
  theme(legend.position = "none") +
  scale_y_continuous(labels = scales::percent, limits = c(0.8 , 1.9)) +
  labs(
    subtitle = "Monthly Number of Defendants Sentenced, Case-Days*, and Average Case Length as a \nPercent of February 2011 Value",
    title = "Average Case Length Increases Even As Total Number \nof Defendants Sentenced Decreases",
    y="Percent of February 2011 Value",
    x = "Year",
    caption = "Source: Cook County State Attorney's Office \nData Portal - Sentences
    \n*Case-days are the sum of case lengths for all the cases sentenced in a given month, many of them concurrently. If 10 defendants\nwere sentenced in a month and each case took 25 days to complete, 250 case-days would have been spent that month."
  ) +
  geom_text(aes(x = as.Date("2012-06-01"), y = 1.65, label = "Case-days* Spent\nPer Month"),color="#0B729A",family="Tahoma",face="plain",size=3) +
  geom_text(aes(x = as.Date("2015-05-01"), y = .90, label = "Defendants Sentenced\nPer Month"),color="#0B9157",family="Tahoma",face="plain",size=3) +
  geom_text(aes(x = as.Date("2017-09-01"), y = 1.60, label = "Average Case\n Length Per Month"),
            color="#99112C",family="Tahoma",face="plain",size=3) +
  geom_hline(yintercept = 1, color = "gray70", linetype="dashed") +
  my_theme +
  theme(plot.margin = margin(.5,.5,.1,.1,"cm"),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) +
  annotate("segment",y=1.65,yend = 1.40,x=as.Date("2016-01-01"), xend=as.Date("2016-08-01"), linetype="dashed") +
  annotate("text", x=as.Date("2015-01-01"), y = 1.75, family = "Tahoma", size=2.5, hjust=0, label = "Case-days stop following the decline of \nnumber of defendants, suggesting\nmore days are spent on fewer cases")

ggsave(here("data_output","cases_sentenced_avg_case_length.pdf"),plot1,device="pdf",width=8,height=5)
plot1
```

Average case length increases consistently from 2011 to 2018. Until approximately 2015, the number of defendants sentenced per month is rising and total number of days is rising at a faster rate which could explain the rise in average case length from 2011 to 2015. As the number of defendants increases, the Office is under more pressure, which would cause the total number of days spent to increase at a faster rate. However, if this was the full explanation, we would see the total number of days decrease as the number of defendants declines sharply after 2015. While this appears true from 2014 to 2016, after 2016 the total number of days plateaus while the number of total defendants per month continues to decline. From 2016 to 2018, there seem to be two simultaneous trends that are increasing the average case length: decreasing number of defendants $\textit{and}$ a steady or slightly increasing number of days spent on cases. In other words, the Office is spending more days on fewer cases.

### Breakdown of Offense Types
To explain this trend further, I turn to types of offenses. I want to understand which offense types are driving the decline in number of defendants, as well as which offense types are driving the rise in total number of days spent. In order to do this, I first look at the breakdown of offense types for all cases sentenced from 2011 to 2018.

```{r warning=FALSE, message = FALSE,fig.align='center',fig.width=5,echo=FALSE}
intake %<>% 
  mutate(RECEIVED_DATE = as.Date(RECEIVED_DATE,'%m/%d/%Y')) %>% 
  mutate(receive_month = round_date(RECEIVED_DATE, "month")) %>% 
  mutate(Offense_Category_broad = case_when(
    grepl("Retail Theft", Offense_Category) ~ "Retail Theft",
    grepl("Burglary", Offense_Category) ~ "Burglary",
    grepl("Homicide", Offense_Category) ~ "Homicide",
    grepl("Robbery", Offense_Category) ~ "Robbery",
    grepl("Battery", Offense_Category) ~ "Battery",
    grepl("Assault", Offense_Category) ~ "Battery",
    grepl("DUI", Offense_Category) ~ "DUI",
    grepl("UUW", Offense_Category) ~ "Unlawful Use \n of Weapon",
    Offense_Category == "Theft" ~ "Theft\n (Non-retail)",
    Offense_Category == "Narcotics" ~ "Narcotics",
    Offense_Category == "Sex Crimes" ~ "Sex Crimes",
    Offense_Category == "Possession of Stolen Motor Vehicle" ~ "MVT",
    Offense_Category == "Driving With Suspended Or Revoked License" ~ "Driving With \n Revoked License",
    TRUE ~ "Other (e.g. Forgery, \n Identity Theft)"    
  )) 

intake_other <- intake %>% 
  filter(Offense_Category_broad == "Other (e.g. Forgery, \n Identity Theft)")  %>% 
  count(Offense_Category)

initiation %<>%
  filter(PRIMARY_CHARGE=="true")

intake_initiation <- inner_join(intake,initiation, by = "CASE_PARTICIPANT_ID")
int_ini_sent <- inner_join(intake_initiation,sentence,by="CASE_PARTICIPANT_ID") 

intake_count <- int_ini_sent %>% 
  mutate(year = round_date(receive_month,"year")) %>% 
  filter(year < "2018-01-01" & year >= "2011-01-01") %>% 
  group_by(Offense_Category_broad) %>% 
  summarise(felonies = n_distinct(CASE_PARTICIPANT_ID)) %>% 
  mutate(pct = round(felonies / sum(felonies),4)) %>% 
  mutate(Percent = paste(round(pct*100),"%",sep="")) %>% 
  mutate(Label = paste(Offense_Category_broad,Percent,sep = "\n"))

```


```{r warning=FALSE, message = FALSE,fig.align='center',fig.height=8,fig.width=5,echo=FALSE}
  
packing <- circleProgressiveLayout(intake_count$pct, sizetype='area')

intake_count2 <- cbind(intake_count,packing)
#plot(intake_count$radius, intake_count$pct)

dat.gg <- circleLayoutVertices(packing, npoints=50)

plot2 <-
ggplot() +
  geom_polygon(data = dat.gg, aes(x, y, group=id, fill=as.factor(id)), colour = "black", alpha = 0.7) +
  geom_text(data = intake_count2, aes(x,y,size=pct,label=Label)) +
  scale_size_continuous(range = c(1,4)) +
  coord_fixed(ratio=1/1.1) +
  labs(
    title = "Top Five Categories Make Up 65% \nof All Offenses Sentenced",
    subtitle = "Breakdown of Felonies Sentenced from 2011 to 2018 By Offense Type",
    y="",
    x = "",
    caption = "Source: Cook County State Attorney's Office\n Data Portal - Intake, Initiations, and Sentences"
  ) + 
  theme(legend.position="none") +
  my_theme +
  theme(plot.margin = margin(.5,.3,.5,.3,"cm"),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank(),
        axis.text = element_blank(),
        axis.line = element_blank()) +
  scale_fill_manual(values = c("#A7A7A2","#99112C","#A7A7A2",
                               
                               "#99112C","#A7A7A2","#A7A7A2",
                               
                               "#99112C","#A7A7A2","#99112C",
                               
                               "#A7A7A2","#A7A7A2","#A7A7A2",
                               
                               "#99112C"))
                               

#ggsave(here("data_output","breakdown_offense_type.pdf"),plot2,device="pdf",width=8,height=5)
plot2

```

It should be noted here that defendants can have multiple offense types. For example, someone arrested for burglary may also have been found with drugs on them, and may be prosecuted and sentenced for both charges separately. Instead of using offense types at the charge level, I use the broad "Offense Type" variable from the Intake file, which represents all case participants -- not charges -- that are brought in to the SAO for review. If the SAO decides to prosecute, a case is "initiated" and the specific charges are determined. To simplify the analysis, I use the broad offense type from the Intake file and merge this onto the sentences data, which is already restricted to the top level charge. 

Narcotics, at approximately 30\%, make up the largest portion of all offenses sentenced. Collectively, narcotics, unlawful use of weapon, DUIs, retail theft, burglary, and battery make up approximately 65\% of all offenses sentenced. The "Other Crimes" category contains approximately 60 distinct crimes such as forgery, escape (failure to return), identity theft and credit card fraud. 

### Different Offenses Over Time
Next, I want to look at which of these offenses are, over time, contributing to the trend of decreasing number of cases we saw in the first graph. 

```{r warning=FALSE, message = FALSE,fig.align='center',echo=FALSE}
# Next, we construct the graphs to figure out if if any particular types of
# felonies are causing the increase or decrease in total defendants sentenced

intake_initiation_fel_by_offense <- int_ini_sent %>% 
  group_by(receive_month, Offense_Category_broad) %>% 
  summarise(felonies = n_distinct(CASE_PARTICIPANT_ID)) %>% 
  filter(receive_month > "2012-01-01" & receive_month < "2018-01-01") 
  
intake_initiation_2012 <- intake_initiation_fel_by_offense %>% 
  mutate(receive_month2 = case_when(
    receive_month=="2012-02-01" ~ "Start",
    receive_month=="2017-12-01" ~ "End",
    TRUE ~ "")) %>% 
  group_by(receive_month2) %>% 
  select(-receive_month) %>% 
  filter(receive_month2 == "Start" | receive_month2 == "End") %>% 
  spread(receive_month2,felonies) %>% 
  mutate(change = abs((End-Start)/Start))

int_init_by_off_pct <- left_join(intake_initiation_fel_by_offense, intake_initiation_2012, by="Offense_Category_broad")

int_init_by_off_pct$Offense_Category_broad <- factor(int_init_by_off_pct$Offense_Category_broad, levels = c(
  "Retail Theft", "DUI", "Narcotics","Unlawful Use of Weapon", "Battery","Homicide","MVT",
  "Driving With Revoked License", "Burglary", "Other", "Theft", "Robbery", "Sex Crimes"),ordered=TRUE)
                                                     
```

```{r warning=FALSE, message = FALSE,fig.align='center',echo=FALSE}

plot3 <- int_init_by_off_pct %>% 
  filter(Offense_Category_broad %in% c("Retail Theft", "DUI", "Narcotics","Robbery",
                                       "Sex Crimes","Homicide")) %>% 
  ggplot(aes(y=felonies, x=receive_month, color=Offense_Category_broad))  +
  geom_point(size=0.4,alpha=1) +
  geom_smooth(size=0.3, se=FALSE) +
  facet_wrap(~Offense_Category_broad, scales = "free") +
  scale_color_manual(values=c("#0B729A","#095E7F","#052F40", 
                              "#99112C", "#E51942", "#A6122F")) +
  labs(
    title = "Retail Theft, DUIs, and Narcotics Cases Drive Decrease in \nNumber of Cases Sentenced",
    subtitle = "Number of Cases Sentenced Per Month by Offense Type from 2012 to 2018",
    caption = "Source: Cook County State Attorney's Office\n Data Portal - Initiations, Intake, and Sentences",
    x = "Year",
    y = "Number of Cases Per Month") +
  my_theme +
  theme(legend.position = "none",
        panel.grid.minor.y = element_blank()) +
  theme(strip.text = element_text(size = rel(1.1),color="white",family="Tahoma", face="bold")) +
  theme(strip.background = element_rect(fill = "grey50"))
  

ggsave(here("data_output","num_cases_by_offense.pdf"),plot3,device = "pdf",width=8,height=5)

plot3
```


The above graph plots total number of felonies sentenced from 2012 to 2018, faceted by offense type, for the 6 offense types that had the greatest absolute change in number of felonies from 2012 to 2018. Note, the window now starts at 2012 instead of 2011. This is because the Intake data begins in 2011, and since I've only kept the universe of case participants that are in both Intake and Sentences datasets, I shortened the window. Otherwise, cases that take longer to prosecute (e.g. homicide) would exist in very small numbers in 2011 if they were only initiated in 2011, which would artificially deflate the number of homicide convictions.

From the above graph, we see that retail theft, DUIs and narcotics are driving the decline in number of cases sentenced. These trends are partially explained by policy changes instituted by former Governor Rauner and State's Attorney Kim Foxx. Starting in 2011, Chicago had decriminalized possession of small amounts of marijuana, and a statewide bill approved in July 2016 by Governor Rauner further forced police officers to stop arresting those caught with small amounts of drugs. Also in late 2016, SA Kim Foxx announced that retail-theft cases would be considered misdemeanors (not felonies) unless the suspect stole merchandise worth \$1,000 or higher. Until this change, the threshold was \$300. This policy change can clearly be seen in the steep drop in retail-theft cases around 2017.

### Case Lengths By Offense Type
Having better understood which offense types are driving the decline in number of cases, I turn to looking at which offense types are driving the increase in case length.

```{r warning=FALSE, message = FALSE,fig.align='center',fig.width=8, fig.height=8,echo=FALSE}

# Want to calculate avg length per case (first collapse by Case participant) and then avg length
# per offense type, broken down into 2 time periods (before and after 2016)
lengths_by_offense <- int_ini_sent %>% 
  filter(case_length_total < 2000 & case_length_total >0) %>% 
  mutate(YEAR = format(sentence_month,"%Y")) %>% 
  filter(YEAR != "2019") %>% 
  filter(YEAR != "2020") %>%
  filter(YEAR != "2018") %>%
  #mutate(YEAR = as.factor(YEAR)) %>% 
  group_by(YEAR, Offense_Category_broad, CASE_PARTICIPANT_ID) %>% 
  summarise(case_length_p = mean(case_length_total, na.rm = TRUE))

lengths_by_offense$YEAR <- factor(lengths_by_offense$YEAR, levels = c("2017", "2016","2015","2014","2013","2012","2011"), ordered = TRUE)

lengths_by_offense_2016 <- int_ini_sent %>% 
  filter(case_length_total < 2000 & case_length_total >0) %>% 
  mutate(after_2016 = ifelse(sentence_month > "2016-01-01","after","before")) %>% 
  group_by(after_2016, Offense_Category_broad, CASE_PARTICIPANT_ID) %>% 
  summarise(case_length_p = mean(case_length_total, na.rm = TRUE))

lengths_by_off_change <-lengths_by_offense_2016 %>% 
  group_by(after_2016, Offense_Category_broad) %>% 
  summarise(mean_length = mean(case_length_p)) %>% 
  spread(after_2016, mean_length) %>% 
  mutate(change = abs((after-before)/before))
  
lengths_by_offense_2016$after_2016 <- factor(lengths_by_offense_2016$after_2016, levels = c("before","after"), labels = c("Before 2016", "After 2016"), ordered = TRUE)
```

```{r warning=FALSE, message = FALSE,fig.align='center',fig.width=8, fig.height=8,echo=FALSE}
# data <- lengths_by_offense %>% 
#   filter(Offense_Category_broad %in% c("Homicide","DUI","Unlawful Use \n of Weapon","Sex Crimes")) %>%
#   ggplot() +
#   geom_density_ridges(aes(y=YEAR, x=case_length_p, fill=Offense_Category_broad), alpha=0.6) 
# 

plot4<-lengths_by_offense_2016 %>% 
  filter(Offense_Category_broad %in% c("Homicide","DUI","Unlawful Use \n of Weapon","Sex Crimes")) %>% 
  ggplot(aes(x=case_length_p,fill=after_2016)) +
  geom_density(alpha=0.5) +
  stat_density(aes(x=case_length_p,fill=after_2016),geom="line",position = "identity") +
  facet_wrap(~Offense_Category_broad,ncol=2) +
  labs(
    title = "Case Lengths Increased After Policy Changes, New SA in 2016",
    subtitle = "Distribution of Case Lengths by Offense Type from 2011 to 2018",
    caption = "Source: Cook County State Attorney's Office\n Data Portal - Initiations, Intake, and Sentences",
    x = "Length of Case (Days)",
    y = "Density",
    fill = ""
  ) + 
  scale_fill_manual(values = c("#99112C","#0B729A")) +
  my_theme +
  theme(strip.text = element_text(size = rel(1.1),color="white",family="Tahoma",face = "bold")) +
  theme(strip.background = element_rect(fill = "grey50"))

ggsave(here("data_output","case_length_offense_type.pdf"),plot4,device="pdf",width=8,height=5)
plot4
```

For the figure above, I choose 2016 as the cut off since there were a number of changes in that year that may have impacted the system as a whole, such as the policy changes mentioned above and the election of a new State's Attorney. 

The distribution of case lengths shifts right across all offense types, though it is not clear why. One explanation is that this is a purely mechanical effect - since "lower level" crimes are falling, the crimes left to prosecute are crimes that naturally take longer to prosecute, and this shifts the distribution. However, this explanation does not fully explain why the total number of days spent on cases in the first graph is holding steady or increasing, because there should still be a mechanical decline in time spent if fewer cases are being prosecuted. A second explanation is that there is something about the changes in 2016 causing this increase in case length - new State's Attorneys often come in with a new set of priorities and procedures, and those could be causing lags.


### Beyond Offense Types
#### Variation in Case Length by Judges and Circuit Court Districts

```{r warning=FALSE, message = FALSE,fig.align='center', fig.width=8,echo=FALSE}
# I want to see if there's any interesting variation in case length by District or Judge

judge_count <- int_ini_sent %>% 
  filter(Offense_Category_broad %in% c("Homicide", "Sex Crimes", "DUI", "Retail Theft", "Narcotics","Unlawful Use of Weapon")) %>%
  filter(case_length_total < 2000 & case_length_total > 0) %>% 
  filter(COURT_NAME != "") %>% 
  filter(SENTENCE_JUDGE != "") %>% 
  group_by(COURT_NAME,SENTENCE_JUDGE,CASE_PARTICIPANT_ID) %>%
  summarise(case_length_p = mean(case_length_total, na.rm = TRUE)) %>%
  group_by(COURT_NAME,SENTENCE_JUDGE) %>%
  summarise(total_sentences = n_distinct(CASE_PARTICIPANT_ID), 
            total_case_length = sum(case_length_p, na.rm = TRUE),
            avg_case_length =  mean(case_length_p, na.rm = TRUE))
```

```{r warning=FALSE, message = FALSE,fig.align='center', fig.width=8,echo=FALSE}
plot5 <-
judge_count %>% 
  filter(COURT_NAME %in% c("District 1 - Chicago","District 2 - Skokie","District 5 - Bridgeview",
                           "District 6 - Markham")) %>% 
  filter(total_sentences > 100 ) %>% 
  ggplot(aes(x=total_sentences, y=total_case_length/100000)) +
  geom_jitter(aes(size=avg_case_length,color=COURT_NAME),alpha=0.4, position = "jitter") +
  scale_y_log10() +
  scale_x_continuous(breaks=c(200,400,600,800,1000,1200,1400,1600)) +
  scale_size(limits = c(200,400), range=c(1,6)) +
  labs(
    title="Judges in Chicago Sentence Cases Faster Than Judges in\nMarkham and Skokie",
    x = "Total Cases Sentenced By Judge",
    y = "Log of Case-Days* Spent By Judge \n (Hundreds of Thousands of Days)",
    subtitle="Total number of cases, case-days, and average case length by judge for four largest districts",
    color = "Circuit Court District",
    size = "Average Case \n Length (Days)",
    caption = "Source: Cook County State Attorney's Office \n Data Portal - Initiations, Intake, and Sentences \n
    *Case-days is the sum of case lengths for all the cases the judge worked on, many of them concurrently.")  +
  annotate("text", x = 100, y = 2.8, family = "Tahoma", size=2.5, hjust=0, label = "This Markham judge spent ~100,000\ncase-days* on 300 cases, while other judges\nspent far fewer case-days on a \nsimilar number of cases.") +
  annotate("segment", xend = 290, x = 200, yend = 1.1, y = 1.9,color="black", arrow=arrow(length = unit(0.03, "npc"))) + 
  my_theme +
  scale_color_manual(values = c("#99112C","#FF2E58","#0B9157","#0B729A")) +
  theme(
    panel.grid.major.y = element_blank(),
    panel.grid.minor.y = element_blank(),
    legend.direction = "vertical", 
        legend.position = c(0.6,0.4),
        legend.box = "horizontal"
    )
  
ggsave(here("data_output","case_length_by_judge"),plot5,device="pdf",width=8,height=5)
plot5

```

Beyond offense types, I am also interested in seeing if the delays in sentencing cases are uniformly distributed across judges and districts. The figure above suggests that they are not. For the same total number of cases sentenced, we see fairly large variation in the total number of days spent on all cases by judges. For example, for judges who sentenced approximately 300 cases, some judges - particularly in courts serving the southern suburbs (District 6) - spent more days than other judges. Judges from Markham seem to consistently spend more days on cases than their counterparts in Chicago, Skokie, and Bridgeview. This could be signal that more resources are needed in Markham, perhaps, but more work is needed to understand these trends.


```{r, warning=FALSE, message = FALSE,fig.align='center', results='hide', fig.keep='all',echo=FALSE}
municipality <- st_read(here('data_source','Municipality','Municipality.shp'))

municip_only_cities <- municipality %>% 
  #filter(!is.na(MUNICIPALI)) %>% 
  mutate(municip = trimws(toupper(MUNICIPALI)))

# Group municipalities in Chicago into Circuit Court Districts (which match the division from Graph 5 above)
municip_only_cities <- municip_only_cities %>% 
  mutate(district = case_when(
    
    AGENCY_DES == "BARRINGTON TWP" ~3,
    AGENCY_DES == "PALATINE TWP" ~3,
    AGENCY_DES == "WHEELING TWP" ~3,
    AGENCY_DES == "ELK GROVE TWP" ~3,
    AGENCY_DES == "SCHAUMBURG TWP" ~3,
    AGENCY_DES == "HANOVER TWP" ~3,
    
    municip == "ROLLING MEADOWS" ~ 3,
    municip == "SOUTH BARRINGTON" ~ 3,
    municip == "BARRINGTON" ~ 3,
    municip == "BARRINGTON HILLS" ~ 3,
    municip == "EAST DUNDEE" ~ 3,
    municip == "HOFFMAN ESTATES" ~ 3,
    municip == "SCHAUMBURG" ~ 3,
    municip == "STREAMWOOD" ~ 3,
    municip == "BARTLETT" ~ 3,
    municip == "PROSPECT HEIGHTS" ~ 3,
    municip == "ARLINGTON HEIGHTS" ~ 3,
    municip == "WHEELING" ~ 3,
    municip == "DEER PARK" ~ 3,
    municip == "MOUNT PROSPECT" ~ 3,
    municip == "BUFFALO GROVE" ~ 3,
    municip == "ELGIN" ~ 3,
    municip == "HANOVER PARK" ~ 3,
    municip == "ROSELLE" ~ 3,
    municip == "ELK GROVE VILLAGE" ~ 3,
    municip == "PALATINE" ~ 3,
    municip == "INVERNESS" ~ 3,
    municip == "ROSEMONT" ~ 3,
    municip == "HARWOOD HEIGHTS" ~ 3,
    municip == "SCHILLER PARK" ~ 3,
    municip == "NORRIDGE" ~ 3,
    
    
    AGENCY_DES == "NORTHFIELD TWP" ~ 2,
    AGENCY_DES == "MAINE TWP" ~ 2,
    AGENCY_DES == "NILES TWP" ~ 2,
    AGENCY_DES == "NEW TRIER TWP" ~ 2,
    AGENCY_DES == "EVANSTON TWP" ~ 2,
    
    municip == "DEERFIELD" ~ 2,
    municip == "NORTHBROOK" ~ 2,
    municip == "NORTHFIELD" ~ 2,
    municip == "GLENCOE" ~ 2,
    municip == "GLENVIEW" ~ 2,
    municip == "DES PLAINES" ~ 2,
    municip == "PARK RIDGE" ~ 2,
    municip == "SKOKIE" ~ 2,
    municip == "EVANSTON" ~ 2,
    municip == "PARK RIDGE" ~ 2,
    municip == "MORTON GROVE" ~ 2,
    municip == "KENILWORTH" ~ 2,
    municip == "WILMETTE" ~ 2,
    municip == "WINNETKA" ~ 2,
    municip == "LINCOLNWOOD" ~ 2,
    municip == "NILES" ~ 2,
    municip == "GOLF" ~ 2,
    
    municip == "CHICAGO" ~ 1,
    
    AGENCY_DES == "LEYDEN TWP" ~ 4,
    AGENCY_DES == "PROVISO TWP" ~ 4,
    
    municip == "BENSENVILLE" ~ 4,
    municip == "FRANKLIN PARK" ~ 4,
    municip == "RIVER GROVE" ~ 4,
    municip == "ELMWOOD PARK" ~ 4,
    municip == "NORTHLAKE" ~ 4,
    municip == "MELROSE PARK" ~ 4,
    municip == "RIVER FOREST" ~ 4,
    municip == "OAK PARK" ~ 4,
    municip == "STONE PARK" ~ 4,
    municip == "MAYWOOD" ~ 4,
    municip == "BERKELEY" ~ 4,
    municip == "BELLWOOD" ~ 4,
    municip == "ELMHURST" ~ 4,
    municip == "HILLSIDE" ~ 4,
    municip == "FOREST PARK" ~ 4,
    municip == "OAK BROOK" ~ 4,
    municip == "WESTCHESTER" ~ 4,
    municip == "BERWYN" ~ 4,
    municip == "LA GRANGE PARK" ~ 4,
    municip == "BROOKFIELD" ~ 4,
    municip == "RIVERSIDE" ~ 4,
    municip == "NORTH RIVERSIDE" ~ 4,
    municip == "CICERO" ~ 4,
    municip == "BROADVIEW" ~ 4,
    
    AGENCY_DES == "ORLAND TWP" ~ 5,
    AGENCY_DES == "WORTH TWP" ~ 5,
    AGENCY_DES == "PALOS TWP" ~ 5,
    AGENCY_DES == "LEMONT TWP" ~ 5,
    AGENCY_DES == "LYONS TWP" ~ 5,
    
    municip == "LYONS" ~ 5,
    municip == "STICKNEY" ~ 5,
    municip == "FOREST VIEW" ~ 5,
    municip == "LA GRANGE" ~ 5,
    municip == "WESTERN SPRINGS" ~ 5,
    municip == "MC COOK" ~ 5,
    municip == "SUMMIT" ~ 5,
    municip == "HINSDALE" ~ 5,
    municip == "COUNTRYSIDE" ~ 5,
    municip == "INDIAN HEAD PARK" ~ 5,
    municip == "HODGKINS" ~ 5,
    municip == "BURR RIDGE" ~ 5,
    municip == "JUSTICE" ~ 5,
    municip == "BEDFORD PARK" ~ 5,
    municip == "BURBANK" ~ 5,
    municip == "BRIDGEVIEW" ~ 5,
    municip == "WILLOW SPRINGS" ~ 5,
    municip == "HICKORY HILLS" ~ 5,
    municip == "HOMETOWN" ~ 5,
    municip == "EVERGREEN PARK" ~ 5,
    municip == "OAK LAWN" ~ 5,
    municip == "CHICAGO RIDGE" ~ 5,
    municip == "PALOS HILLS" ~ 5,
    municip == "WORTH" ~ 5,
    municip == "PALOS PARK" ~ 5,
    municip == "PALOS HEIGHTS" ~ 5,
    municip == "LEMONT" ~ 5,
    municip == "ALSIP" ~ 5,
    municip == "MERRIONETTE PARK" ~ 5,
    municip == "ORLAND PARK" ~ 5,
    municip == "HOMER GLEN" ~ 5,
    municip == "ORLAND HILLS" ~ 5,
    
    AGENCY_DES == "BLOOM TWP" ~ 6,
    AGENCY_DES == "THORNTON TWP" ~ 6,
    AGENCY_DES == "RICH TWP" ~ 6,
    AGENCY_DES == "BREMEN TWP" ~ 6,
    
    municip == "CALUMET PARK" ~ 6,
    municip == "BLUE ISLAND" ~ 6,
    municip == "CRESTWOOD" ~ 6,
    municip == "ROBBINS" ~ 6,
    municip == "RIVERDALE" ~ 6,
    municip == "DIXMOOR" ~ 6,
    municip == "POSEN" ~ 6,
    municip == "MIDLOTHIAN" ~ 6,
    municip == "OAK FOREST" ~ 6,
    municip == "HARVEY" ~ 6,
    municip == "PHOENIX" ~ 6,
    municip == "DOLTON" ~ 6,
    municip == "BURNHAM" ~ 6,
    municip == "CALUMET CITY" ~ 6,
    municip == "SOUTH HOLLAND" ~ 6,
    municip == "MARKHAM" ~ 6,
    municip == "HAZEL CREST" ~ 6,
    municip == "TINLEY PARK" ~ 6,
    municip == "COUNTRY CLUB HILLS" ~ 6,
    municip == "HOMEWOOD" ~ 6,
    municip == "EAST HAZEL CREST" ~ 6,
    municip == "THORNTON" ~ 6,
    municip == "LANSING" ~ 6,
    municip == "FLOSSMOOR" ~ 6,
    municip == "GLENWOOD" ~ 6,
    municip == "LYNWOOD" ~ 6,
    municip == "CHICAGO HEIGHTS" ~ 6,
    municip == "MATTESON" ~ 6,
    municip == "OLYMPIA FIELDS" ~ 6,
    municip == "FORD HEIGHTS" ~ 6,
    municip == "SAUK VILLAGE" ~ 6,
    municip == "STEGER" ~ 6,
    municip == "PARK FOREST" ~ 6,
    municip == "SOUTH CHICAGO HEIGHTS" ~ 6,
    municip == "RICHTON PARK" ~ 6,
    municip == "FRANKFORT" ~ 6,
    TRUE ~ 0
  ))
```

```{r, warning=FALSE, message = FALSE,fig.align='center',echo=FALSE}

sentence %<>%
  mutate(municip = LAW_ENFORCEMENT_AGENCY) %>% 
  mutate(municip = gsub("PD","",municip)) %>% 
  mutate(municip = gsub("P.D.","",municip)) %>% 
  mutate(municip = gsub("POLICE DEPARTMENT","",municip)) %>% 
  mutate(municip = gsub("POLICE DEPT","",municip)) %>% 
  mutate(municip = trimws(municip)) 

case_length <- sentence %>% 
  filter(sentence_month > "2011-01-01" & sentence_month < "2018-01-01") %>% 
  group_by(municip, CASE_PARTICIPANT_ID) %>% 
  summarise(case_length_p = mean(case_length_total, na.rm = TRUE)) %>% 
  group_by(municip) %>% 
  summarise(felonies_total = n_distinct(CASE_PARTICIPANT_ID), 
            case_length_total = sum(case_length_p, na.rm = TRUE),
            avg_case_length = mean(case_length_p, na.rm = TRUE)) %>% 
  filter(felonies_total > 0) %>% 
  filter(case_length_total > 0) %>% 
  filter(avg_case_length > 0 & avg_case_length < 2000) %>% 
  filter(felonies_total > 10)

case_length_munici_w_data <- (left_join(case_length,municip_only_cities,by="municip") %>% 
                         filter(!is.na(MUNICIPALI)))

case_length_munici_n_data <- (full_join(case_length,municip_only_cities,by="municip") %>% 
                         filter(is.na(avg_case_length)))
```

```{r warning=FALSE, message = FALSE,fig.align='center',echo=FALSE}
# Create a theme that customizes my theme specifically for maps
my_theme_maps <- my_theme +
                  theme_map() +
                  theme(
                      axis.title.y = element_blank(),
                      axis.title.x = element_blank(),
                      axis.text.y = element_blank(),
                      axis.text.x = element_blank(),
                      axis.ticks = element_blank(),
                      panel.background = element_blank(),
                      panel.grid = element_line(color = "#FFFFFF"),
                      legend.position = c(0.15,0.15),
                      
                      plot.title = element_text(family="Tahoma", face="bold", size=14, hjust = 0),
                      plot.subtitle = element_text(family="Tahoma",size=10),
                      #plot.margin=unit(c(.3,.1,.3,.1),"cm"),
                      plot.caption = element_text(family="Tahoma", size=8))



```

```{r, warning=FALSE, message = FALSE,fig.align='center', fig.width=10, fig.height=8,results='hide', fig.keep='all',echo=FALSE}

municip_only_cities_1 <- municip_only_cities %>% 
  filter(district==1) %>% 
  st_union()

municip_only_cities_2 <- municip_only_cities %>% 
  filter(district==2) %>% 
  st_union()

municip_only_cities_3 <- municip_only_cities %>% 
  filter(district==3) %>% 
  st_union()

municip_only_cities_4 <- municip_only_cities %>% 
  filter(district==4) %>% 
  st_union()

municip_only_cities_5 <- municip_only_cities %>% 
  filter(district==5) %>% 
  st_union()

municip_only_cities_6 <- municip_only_cities %>% 
  filter(district==6) %>% 
  st_union()


ggplot() +
  geom_sf(data = case_length_munici_w_data, aes(fill=avg_case_length), lwd=0) +
  geom_sf(data = case_length_munici_n_data, fill = "grey80", lwd=0) +
  geom_sf(data = municip_only_cities_6,fill=NA,color="grey40") +
  geom_sf(data = municip_only_cities_1,fill=NA,color="grey40") +
  geom_sf(data = municip_only_cities_2,fill=NA,color="grey40") +
  geom_sf(data = municip_only_cities_3,fill=NA,color="grey40") +
   geom_sf(data = municip_only_cities_4,fill=NA,color="grey40") +
  geom_sf(data = municip_only_cities_5,fill=NA,color="grey40") +
  my_theme_maps +
  scale_fill_gradient(low="#FFC2C0",high="#99112C") +
  annotate("text", x = 1070000, y = 1910000, family = "Tahoma", size=2.5, hjust=0.5, label = "District 1 - \nChicago") +
  #annotate("segment", x = 1180000, xend = 1200000, y = 1870000, yend = 1900000, color="black", linetype="dashed") +
  annotate("segment", x = 1080000, xend = 1100000, y = 1910000, yend = 1935000, color="black", linetype="dashed") +
  annotate("segment", x = 1080000, xend = 1150000, y = 1910000, yend = 1920000, color="black", linetype="dashed") +
  
  annotate("text", x = 1180000, y = 1990000, family = "Tahoma", size=2.5, hjust=0.5, label = "District 2 - \nSkokie") +
  annotate("segment", x = 1140000, xend = 1170000, y = 1970000, yend = 1990000, color="black", linetype="dashed") +
  annotate("text", x = 1030000, y = 1920000, family = "Tahoma", size=2.5, hjust=0.5, label = "District 3 - \nRolling Meadows") +
  annotate("segment", x = 1030000, xend = 1030000, y = 1930000, yend = 1950000, color="black", linetype="dashed") +
  annotate("text", x = 1060000, y = 1875000, family = "Tahoma", size=2.5, hjust=0.5, label = "District 4 - \nMaywood") +
  annotate("segment", x = 1070000, xend = 1100000, y = 1880000, yend = 1900000, color="black", linetype="dashed") +
  annotate("text", x = 1060000, y = 1840000, family = "Tahoma", size=2.5, hjust=0.5, label = "District 5 - \nBridgeview") +
  annotate("segment", x = 1070000, xend = 1100000, y = 1840000, yend = 1835000, color="black", linetype="dashed") +
  annotate("text", x = 1105000, y = 1760000, family = "Tahoma", size=2.5, hjust=0.5, label = "District 6 - \nMarkham") +
  annotate("segment", x = 1120000, xend = 1150000, y = 1760000, yend = 1760000, color="black", linetype="dashed") +
  annotate("rect", xmin = 1005000, xmax =1009000, ymin = 1815000, ymax = 1819000, color = "black",fill="grey90") +
  annotate("text", x = 1015000, y = 1817000, family = "Tahoma", size=3.5, hjust=0, label = "Unavailable*") +
  labs(
    title="Municipalities in Circuit Court Districts 2 and 6 \nDriving High Average Case Lengths",
    y = "",
    x = "",
    subtitle="Average case length in days by Cook County Municipalities (2011 to 2018)",
    fill = "Average Case \nLength (Days)",
    caption = "Source: Cook County State Attorney's Office \nData Portal - Sentences; Circuit Court of Cook County;\nCook County Government - Cook Central Data Portal
    
    *No cases in relevant years or municipal townships. Townships usually do not have \ntheir own police deparments and are under the jurisdiction of the Sheriff's Office."
  )  

```

The figure above allows us to see the spatial variation in average case length, across the municipalities in Cook County. The SAO data has information on the Law Enforcement Agency (LEAs) that handled a given case, which maps onto the municipalities in Cook County. Consistent with the graph above we see that cases handled by LEAs in municipalities that are in the southern court district (District 6), as well as those in District 2 have a higher average case length than other districts.

### Variation in Conviction Rates

The SAO data also contains information on the disposition of each charge. That is, whether the charge resulted in a conviction (e.g. finding of guilt, guilty plea, etc) or not (e.g. SAO refused to prosecute, case dismissed, no finding of guilt). The figure above takes only the primary charge for each case-participant and plots the conviction rate by municipalities in Cook County.

```{r, warning=FALSE, message = FALSE,fig.align='center', fig.width=12, fig.height=10,results='hide', fig.keep='all',echo=FALSE}
centroid <- st_centroid(municip_only_cities)

disposition %<>%
  mutate(DISPO_DATE = as.Date(DISPO_DATE,'%m/%d/%Y' )) %>% 
  mutate(disp_month = round_date(DISPO_DATE, "month"))  %>%
  filter(disp_month > "2011-01-01" & disp_month < "2018-01-01") %>% 
  filter(PRIMARY_CHARGE == "true") %>% 
  mutate(municip = LAW_ENFORCEMENT_AGENCY) %>% 
  mutate(municip = gsub("PD","",municip)) %>% 
  mutate(municip = gsub("P.D.","",municip)) %>% 
  mutate(municip = gsub("POLICE DEPARTMENT","",municip)) %>% 
  mutate(municip = gsub("POLICE DEPT","",municip)) %>% 
  mutate(municip = trimws(municip)) 

# disposition_charges <- disposition %>% 
#   count(CHARGE_DISPOSITION) 

# Group into -- No conviction vs conviction
disposition %<>%
  mutate(CHARGE_DISPOSITION = trimws(CHARGE_DISPOSITION)) %>% 
  mutate(conviction = case_when(
    CHARGE_DISPOSITION == "Plea Of Guilty" ~ 1,
    CHARGE_DISPOSITION == "Finding Guilty" ~ 1,
    CHARGE_DISPOSITION == "Verdict Guilty" ~ 1,
    CHARGE_DISPOSITION == "Plea of Guilty - Amended Charge" ~ 1,
    
    CHARGE_DISPOSITION == "Nolle Prosecution" ~ 0,
    CHARGE_DISPOSITION == "FNPC" ~ 0,
    CHARGE_DISPOSITION == "FNG" ~ 0,
    CHARGE_DISPOSITION == "Verdict-Not Guilty" ~ 0,
    CHARGE_DISPOSITION == "Case Dismissed" ~ 0,
    CHARGE_DISPOSITION == "Finding Not Not Guilty" ~ 0,
    CHARGE_DISPOSITION == "FNG Reason Insanity" ~ 0,
    
    CHARGE_DISPOSITION == "Death Suggested-Cause Abated" ~ 0,
    CHARGE_DISPOSITION == "BFW" ~ 0,
    CHARGE_DISPOSITION == "Transferred - Misd Crt" ~ 0,
    TRUE ~ -99
  )) %>% 
  mutate(conviction = ifelse(conviction==-99,NA,conviction))

# disposition_conv <- disposition %>%
#    filter(conviction==0) %>%
#    count(CHARGE_DISPOSITION)

disp_by_municip <- disposition %>% 
  group_by(municip) %>% 
  summarise(conviction_rate = mean(conviction, na.rm = TRUE),
            cases = n_distinct(CASE_PARTICIPANT_ID)) %>% 
  filter(cases > 10)

disp_by_municip_w_data <- (left_join(disp_by_municip,centroid,by="municip") %>% 
                         filter(!is.na(MUNICIPALI)))

disp_by_municip_n_data <- (full_join(disp_by_municip,municip_only_cities,by="municip") %>% 
                         filter(is.na(conviction_rate)))

disp_by_municip_w_data <- disp_by_municip_w_data %>% 
  mutate(conviction_rate_bins = case_when(
    conviction_rate >= 0 & conviction_rate < 0.6 ~ "0% to 60%",
    conviction_rate >= 0.6 & conviction_rate < 0.68 ~ "60% to 68%",
    conviction_rate >= 0.68 & conviction_rate < 0.72 ~ "68% to 72%",
    conviction_rate >= 0.72 & conviction_rate < 1 ~ "72% to 100%",
    TRUE ~ "0"
  ))

```

```{r, warning=FALSE, message = FALSE,fig.align='center', fig.width=10, fig.height=8,results='hide', fig.keep='all',echo=FALSE}

disp_by_municip_n_data2 <- disp_by_municip_n_data %>% 
  count(AGENCY_DES)

municip_only_cities_1 <- municip_only_cities %>% 
  filter(district==1) %>% 
  st_union()

municip_only_cities_2 <- municip_only_cities %>% 
  filter(district==2) %>% 
  st_union()

municip_only_cities_3 <- municip_only_cities %>% 
  filter(district==3) %>% 
  st_union()

municip_only_cities_4 <- municip_only_cities %>% 
  filter(district==4) %>% 
  st_union()

municip_only_cities_5 <- municip_only_cities %>% 
  filter(district==5) %>% 
  st_union()

municip_only_cities_6 <- municip_only_cities %>% 
  filter(district==6) %>% 
  st_union()


ggplot() +
  geom_sf(data = municip_only_cities, alpha = 0.6, color="grey90", fill = "#0B729A") +
  geom_sf(data = disp_by_municip_n_data, fill="grey80", color = "grey90") +
  geom_sf(data = disp_by_municip_w_data, 
          aes(color=conviction_rate),
          size=3 ) +
  geom_sf(data = municip_only_cities_6,fill=NA,color="grey40") +
  geom_sf(data = municip_only_cities_1,fill=NA,color="grey40") +
  geom_sf(data = municip_only_cities_2,fill=NA,color="grey40") +
  geom_sf(data = municip_only_cities_3,fill=NA,color="grey40") +
  geom_sf(data = municip_only_cities_4,fill=NA,color="grey40") +
  geom_sf(data = municip_only_cities_5,fill=NA,color="grey40") +
  my_theme_maps +
  scale_fill_manual(values = c("#FFFFFF","#FFDB2C","#7F7A18","#FFF52F","#FFE41E",
                               '#B2AB21', "#7F6E16"), guide = FALSE) +
  #scale_size_manual(values = c(1,1.4,1.8,2.2), guide = FALSE) +
  #scale_color_manual(values = c("#99112C","#FF2E58","#B2AB21","#0B729A")) +
  scale_color_continuous(high="#E51942", low="#E7DE30",labels=c('40%','50%','60%','70%','80%')) +
  annotate("text", x = 1070000, y = 1910000, family = "Tahoma", size=2.5, hjust=0.5, label = "District 1 - \nChicago") +
  #annotate("segment", x = 1180000, xend = 1200000, y = 1870000, yend = 1900000, color="black", linetype="dashed") +
  annotate("segment", x = 1080000, xend = 1100000, y = 1910000, yend = 1935000, color="black", linetype="dashed") +
  annotate("segment", x = 1080000, xend = 1150000, y = 1910000, yend = 1920000, color="black", linetype="dashed") +
  
  annotate("text", x = 1180000, y = 1990000, family = "Tahoma", size=2.5, hjust=0.5, label = "District 2 - \nSkokie") +
  annotate("segment", x = 1140000, xend = 1170000, y = 1970000, yend = 1990000, color="black", linetype="dashed") +
  annotate("text", x = 1030000, y = 1920000, family = "Tahoma", size=2.5, hjust=0.5, label = "District 3 - \nRolling Meadows") +
  annotate("segment", x = 1030000, xend = 1030000, y = 1930000, yend = 1950000, color="black", linetype="dashed") +
  annotate("text", x = 1060000, y = 1875000, family = "Tahoma", size=2.5, hjust=0.5, label = "District 4 - \nMaywood") +
  annotate("segment", x = 1070000, xend = 1100000, y = 1880000, yend = 1900000, color="black", linetype="dashed") +
  annotate("text", x = 1060000, y = 1840000, family = "Tahoma", size=2.5, hjust=0.5, label = "District 5 - \nBridgeview") +
  annotate("segment", x = 1070000, xend = 1100000, y = 1840000, yend = 1835000, color="black", linetype="dashed") +
  annotate("text", x = 1105000, y = 1760000, family = "Tahoma", size=2.5, hjust=0.5, label = "District 6 - \nMarkham") +
  annotate("segment", x = 1120000, xend = 1150000, y = 1760000, yend = 1760000, color="black", linetype="dashed") +
  annotate("rect", xmin = 1005000, xmax =1009000, ymin = 1815000, ymax = 1819000, color = "black",fill="grey90") +
  annotate("text", x = 1015000, y = 1817000, family = "Tahoma", size=3.5, hjust=0, label = "Unavailable*") +
  labs(
    title="Highest Conviction Rates Concentrated in Circuit \nCourt Districts 2 and 3",
    y = "",
    x = "",
    subtitle="Conviction Rate of Primary Charges by Cook County Municipalities (2011 to 2018)",
    color = "Conviction Rate",
    caption = "Source: Cook County State Attorney's Office \nData Portal - Dispositions; Circuit Court of Cook County;\nCook County Government - Cook Central Data Portal
    
    *No cases in relevant years or municipal townships. Townships usually do not have \ntheir own police deparments and are under the jurisdiction of the Sheriff's Office."
  )  
```

Based on the graph above, Districts 2 and 3  appears to have higher conviction rates than most other districts. Municipalities in District 6 also tend to have slightly higher conviction rates. Putting together the spatial variation in case length and spatial variation in conviction rates, there is suggestive evidence that a higher case length is correlated with higher conviction rates. 

### Impact of Bail Reform Bill

Turning to the Bail Reform bill, I analyze the Bond Court Disposition dataset collected by Chicago Appleseed through FOIA requests to explore the preliminary impact of the bill. Illinois law has a number of options for pretrial release, supervision, and incarceration. These include:

* I-Bonds: Individual recognizance bonds. When an accused person is given an I-Bond, the judge sets a dollar amount which must be paid if the accused fails to appear in court, but no payment is required prior to being released.

* EMI: A person is allowed to be released into house arrest with electronic monitoring (EM)

* D-Bond: Deposit Bond. If an accused receives a D-Bond, they must pay 10\% of the D-Bond amount in order to be released from jail.

* C-Bond: Cash Bond. If an accused receives a C-Bond, they must pay the full amount of the Cash Bond to be released.

* No Bail: the accused are ordered incarcerated until the duration of their case

* Bond to stand: Judge upholds a bond type previously set by another judge

* Nolle Pros: Judge decides to not proceed with the case

Using the Bond Court Disposition data, I look at the percentage of cases receiving the various bond types before and after the bill is passed. 


```{r, warning=FALSE, message = FALSE, fig.align='center',echo=FALSE}
# Explore Bond Court Dispositions Data
bond_court_disp <- read.csv(here("data_source","bond-court-dispositions","data","cbc_disposition_stats.csv"),stringsAsFactors = FALSE)

reform <- "2017-09-18"

bond_court_disp %<>%
  mutate(date = as.Date(date,'%Y-%m-%d' )) %>% 
  mutate(sum_cases = Nolle.Pros + No.Bail + Bond.to.Stand + I.Bonds + EMI + D.Bonds + C.Bonds)

# identical(bond_court_disp$sum_cases,bond_court_disp$TOTAL.CASES)
# summary(bond_court_disp$sum_cases)
# summary(bond_court_disp$TOTAL.CASES)
not_equal <- bond_court_disp[which(!identical(bond_court_disp$sum_cases,bond_court_disp$TOTAL.CASES)),]

# Need to collapse this data into before and after reform to see how the pct of different bond types have changed
bond_court_disp %<>%
  mutate(after_reform = ifelse(date>=reform,"after reform","before reform"))

bond_court_disp_sum <- bond_court_disp %>% 
  group_by(after_reform) %>% 
  summarise(sum_nolle = sum(Nolle.Pros), sum_nobail = sum(No.Bail), sum_bts = sum(Bond.to.Stand),
            sum_Ibonds = sum(I.Bonds), sum_emi = sum(EMI), sum_Dbonds = sum(D.Bonds), sum_Cbonds = sum(C.Bonds)) %>% 
  gather(type_bond,cases,sum_nolle:sum_Cbonds)

bond_court_disp_sum_after <- bond_court_disp_sum %>% 
  filter(after_reform == "after reform") %>% 
  mutate(pct_bond = cases / sum(cases))
bond_court_disp_sum_before <- bond_court_disp_sum %>% 
  filter(after_reform == "before reform") %>% 
  mutate(pct_bond = cases / sum(cases))
bond_court_disp_sum <- rbind(bond_court_disp_sum_after,bond_court_disp_sum_before)

bond_court_disp_sum$after_reform <- factor(bond_court_disp_sum$after_reform, levels = c("before reform","after reform"),labels = c("Before Reform", "After Reform"), ordered = TRUE)

bond_court_disp_sum$type_bond <- factor(bond_court_disp_sum$type_bond, 
    levels = c("sum_nolle","sum_nobail","sum_bts","sum_Ibonds","sum_emi","sum_Cbonds","sum_Dbonds"),
    labels = c("Nolle Pros","No Bail", "Bond to Stand","I-Bonds","EMI","C Bonds", "D Bonds"), ordered = TRUE)
```


```{r, warning=FALSE, message = FALSE, fig.align='center',echo=FALSE}
plot6 <- 
bond_court_disp_sum %>% 
  ggplot(aes(area=pct_bond, label = type_bond, fill=type_bond)) +
  geom_treemap() +
  geom_treemap_text(colour = "white", place = "centre",
                    family = "Tahoma", grow = TRUE) +
  facet_wrap(~after_reform) +
   labs(
    title="Sharp Decrease in Secured Money Bonds - D and C Bonds - \nFollowing Reform Bill, Though Usage Still Persists",
    x = "",
    y = "",
    subtitle="Bond Types as Percentage of Total Cases Before and After Bill Passage (January 2017 to April 2018)",
    fill = "Type of Bond",
    caption = "Source: Bond Court Disposition Data Requested Through FOIA, \nAvailable on ChicagoDataCollaborative.org") +
  my_theme +
  #scale_fill_manual(values=c("#FF2E58","#29424C", "#590A1A","#0B729A","#99112C", "#B2AB21","#12BDFF")) +
  scale_fill_manual(values = c("#373B40",
                               "#6D767F",
                               "#848F9A",
                               "#C5D5E5",
                               "#DBECFF",
                               "#FF1D4A","#99112C")) +
                               
                               # "#1081E5","#052440","#128FFF",
                               # "#99112C")) +
  #scale_fill_manual(values = c("gray","gray","gray","gray","gray","black","black")) +
  #labels = c("Nolle Pros","No Bail", "Bond to Stand","I-Bonds","EMI","D Bonds", "C Bonds"),
  
  theme(strip.text = element_text(size = rel(1.1),color="white",family="Tahoma", face="bold")) +
  theme(strip.background = element_rect(fill = "grey50"))

ggsave(here("data_output","bond_court_disp.pdf"),plot6,device="pdf",width=8,height=5)
plot6

```

We see that after the reform bill is passed in September 2017, usage of D-Bonds falls sharply while usage of I-Bonds increases. This is certainly an improvement, as fewer people have to pay a cash amount to ensure their release. However, D-Bonds are still given to roughly 20\% of cases after the reform. Because of the aggregated nature of the Bond Court Dispositions data received through FOIA, any variation in bond decisions by offense type or judges is masked.

The court-watching data confirms that this trend. This suggests the bill has been largely successful at achieving its intended goal. However, more information and a richer dataset is needed to understand if the arbitrary nature of bail decision-making has stopped. For example, we still need more information to know whether the D-Bonds that continue to be given are indeed given to people who present a higher flight risk, and whether their ability to afford the bail amount is taken into consideration. 



